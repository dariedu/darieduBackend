from django.contrib import admin
from django.contrib.auth import get_user_model
from django.core.exceptions import ValidationError
from django.db import models
from django.urls import reverse
from django.utils.html import format_html
from django.utils import timezone

from address_app.models import City


User = get_user_model()


class Promotion(models.Model):
    category = models.ForeignKey('PromoCategory', on_delete=models.SET_NULL,
                                 null=True, blank=True, verbose_name='–∫–∞—Ç–µ–≥–æ—Ä–∏—è')
    name = models.CharField(max_length=255, verbose_name='–Ω–∞–∑–≤–∞–Ω–∏–µ')
    price = models.PositiveIntegerField(verbose_name='—Å—Ç–æ–∏–º–æ—Å—Ç—å')
    description = models.TextField(blank=True, null=True, verbose_name='–æ–ø–∏—Å–∞–Ω–∏–µ',
                                   help_text="""–ì–ª–∞–≤–Ω–æ–µ! –ß—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Ç–∞—Ç—å—Å—è, —Å–ª–µ–¥—É–π—Ç–µ –ø–æ –ø–æ—Ä—è–¥–∫—É –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏! 
                                   –û–±—â–∞—è –∏–¥–µ—è –¥–µ–ª–∏—Ç—Å—è –Ω–∞ —á–µ—Ç—ã—Ä–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —à–∞–≥–∞: 1.–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç => 2. –¥–µ–ª–∏–º –Ω–∞ –∞–±–∑–∞—Ü—ã => 3. –∑–∞–¥–∞–µ–º –∫—Ä–∞—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É => 4. –≤–Ω—É—Ç—Ä–∏ –∞–±–∑–∞—Ü–µ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—Ç–∏–ª–∏
                                   –í—Å–µ —Å–∏–º–≤–æ–ª—ã –ø–∏—à–∏—Ç–µ –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤, —Ä–æ–≤–Ω–æ —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –Ω–∞–ø–∏—Å–∞–Ω—ã –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
                                   –î–ª—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ –∏—Ö –º–æ–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –Ω–∏—á–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞—Ç—å. 
                                   –í—Å–µ —Å–∏–º–≤–æ–ª—ã –Ω–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã!
                                   1. –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ "<l>" : "–ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é"; "<r>" : "–ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é"; "<j>" : "—Ä–∞—Å—Ç—è–Ω—É—Ç—å –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"; "<m>" : "–æ—Ç—Ü–µ–Ω—Ç—Ä–æ–≤–∞—Ç—å"
                                   –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Å–ª–µ–≤–∞. –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç—Å—è –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Å—Ä–∞–∑—É. –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑. –°—Ç–∞–≤–∏–º –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–∞–º—ã–º –Ω–∞—á–∞–ª–æ–º —Ç–µ–∫—Å—Ç–∞, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π. –ï—Å–ª–∏ –Ω–µ –Ω–∞–ø–∏—à–µ—Ç–µ, —Ç–æ –±—É–¥–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Å–ª–µ–≤–∞.
                                   2. –î–µ–ª–∏–º —Ç–µ–∫—Å—Ç –¥–∞ –∞–±–∑–∞—Ü—ã, –≤—Å–µ–≥–¥–∞ –ø–æ 2 —Å—Ç—Ä–æ–∫–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è! —Å–∏–º–≤–æ–ª: <br2>
                                   3. –í –∫–∞–∂–¥–æ–º –∞–±–∑–∞—Ü–µ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É, –∫—Ä–∞—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å —Ä–∞–∑–Ω—ã–º –æ—Ç—Å—Ç—É–ø–æ–º: <p0> - –Ω–µ—Ç –æ—Ç—Å—Ç—É–ø–∞, –¥–∞–ª–µ–µ —Ü–∏—Ñ—Ä—ã –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –æ—Ç—Å—Ç—É–ø
                                    –í–Ω–∏–º–∞–Ω–∏–µ! –Ω–µ –≤—Å–µ —Ü–∏—Ñ—Ä—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å! —Ü–∏—Ñ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 14, 16, 20, 24, 28, 32, 36, 40.
                                    –Ω–∞–ø–∏—Ä–º–µ—Ä <p40>, <p20>, <p32>. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ –∞–±–∑–∞—Ü–∞. –ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π.
                                   4. —Ç–µ–ø–µ—Ä—å –≤ –∫–∞–∂–¥–æ–º –∏–∑ –∞–±–∑–∞—Ü–µ–≤ –º–æ–∂–Ω–æ –ø—Ä–∏–µ–º–Ω—è—Ç—å –¥—Ä—É–≥–∏–µ —Å–∏–º–≤–æ–ª—ã:
                                   <b></b> - –≤—ã–¥–µ–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∂–∏—Ä–Ω—ã–º, –ø—Ä–∏–º–µ—Ä: <b>—Ç–µ–∫—Å—Ç</b> => —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –Ω–∞–ø–∏—Å–∞–Ω –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä
                                   <i><b>—Ç–µ–∫—Å—Ç</b></i> - –∂–∏—Ä–Ω—ã–π –∏ –∫—É—Ä—Å–∏–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ; <u><b>—Ç–µ–∫—Å—Ç</b></u> - –∂–∏—Ä–Ω—ã–π –∏ –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ; <—Å><b>—Ç–µ–∫—Å—Ç</b></—Å> - –∂–∏—Ä–Ω—ã–π –∏ –∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ;)
                                   <i></i> - –≤—ã–¥–µ–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∫—É—Ä—Å–∏–≤–æ–º, –ø—Ä–∏–º–µ—Ä: <i>—Ç–µ–∫—Å—Ç</i> => —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –Ω–∞–ø–∏—Å–∞–Ω –∫—É—Ä—Å–∏–≤–æ–º ( –ù–ï –ú–û–ñ–ï–¢ –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞)
                                   <u></u> - –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç, –ø—Ä–∏–º–µ—Ä: <u>—Ç–µ–∫—Å—Ç</u> => —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç ( –ù–ï –ú–û–ñ–ï–¢ –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞)
                                   <—Å></—Å> - –ø–µ—Ä–µ—á–µ—Ä–∫–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç, –ø—Ä–∏–º–µ—Ä: <c>—Ç–µ–∫—Å—Ç</c> => —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ—á–µ—Ä–∫–Ω—É—Ç ( –ù–ï –ú–û–ñ–ï–¢ –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞)
                                   <br1> - –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: –î–æ–ª–æ–π –±–µ–¥—É ‚Äì –¥–∞—Ä–∏ –µ–¥—É!<br1>ü§ç => —Å–µ—Ä–¥–µ—á–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É.
                                    –ú–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ –ø–æ–¥—Ä—è–¥, –æ–¥–∏–Ω —Ç–∞–∫–æ–π "—Å–∏–º–≤–æ–ª" —Å–æ–∑–¥–∞–µ—Ç –æ–¥–∏–Ω –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
                                    –ë–æ–Ω—É—Å —Å—Å—ã–ª–∫–∞: <link><link>, –Ω–∞–ø—Ä–∏–º–µ—Ä <link>–ª—é–±–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –≤—ã–±–æ—Ä –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤<link>.
                                    —Å—Å—ã–ª–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤ –æ–¥–Ω–æ–º –∞–±–∑–∞—Ü–µ, –∏ –≤—Å—è –≤–æ—Ç —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ (<link>–ª—é–±–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –≤—ã–±–æ—Ä –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤<link>)
                                    –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞ —Å–ª–æ–≤–æ–º "—Ç—É—Ç" –ø–æ –Ω–∞–∂–∞—Ç–∏—é –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ, —Ç–∞–∫, —á—Ç–æ —Å—Å—ã–ª–∫—É –Ω—É–∂–Ω–æ –≤–ø–∏—Å–∞—Ç—å –≤ –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:
                                    –ê <link>–ª—é–±–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –≤—ã–±–æ—Ä –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤<link> –≤—ã –Ω–∞–π–¥–µ—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏. –∏—Ç–æ–≥ => –ê —Ç—É—Ç –≤—ã –Ω–∞–π–¥–µ—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏.""")
    start_date = models.DateTimeField(default=timezone.now, verbose_name='–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞')
    quantity = models.PositiveIntegerField(verbose_name='–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', default=1)
    available_quantity = models.PositiveIntegerField(verbose_name='–¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', default=1,
                                                     help_text='–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–≤–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É. '
                                                               '–ë—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏')
    for_curators_only = models.BooleanField(default=False, verbose_name='—Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤')
    is_active = models.BooleanField(default=True, verbose_name='–∞–∫—Ç–∏–≤–Ω–∞—è')
    ticket_file = models.URLField(blank=True, null=True, verbose_name='—Ñ–∞–π–ª')  # TODO: upload to where ?
    about_tickets = models.TextField(blank=True, null=True, verbose_name='–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–ª–µ—Ç–∞—Ö')

    # –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–æ—â—Ä–µ–Ω–∏—è.
    # –ï—Å–ª–∏ –ø–æ–æ—â—Ä–µ–Ω–∏–µ –±–µ—Å—Å—Ä–æ—á–Ω–æ–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `is_permanent = True`, –∞ –ø–æ–ª–µ `end_date`
    # –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º.
    # –ï—Å–ª–∏ —É –ø–æ–æ—â—Ä–µ–Ω–∏—è –µ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è, –ø–æ–ª–µ `is_permanent` –±—É–¥–µ—Ç `False`, –∏
    # –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –≤ `end_date`.
    is_permanent = models.BooleanField(default=False, verbose_name='–±–µ—Å—Å—Ä–æ—á–Ω–æ–µ –ø–æ–æ—â—Ä–µ–Ω–∏–µ')
    end_date = models.DateTimeField(blank=True, null=True, verbose_name='–¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è',
                                    help_text='–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–æ—â—Ä–µ–Ω–∏–µ –Ω–µ –±–µ—Å—Å—Ä–æ—á–Ω–æ–µ')

    city = models.ForeignKey(City, on_delete=models.PROTECT, verbose_name='–≥–æ—Ä–æ–¥')
    users = models.ManyToManyField(User, through='Participation', blank=True, verbose_name='–ø–æ–ª—É—á–∞—Ç–µ–ª—å')
    picture = models.ImageField(blank=True, null=True, upload_to='promo_pictures/', verbose_name='–∫–∞—Ä—Ç–∏–Ω–∫–∞',
                                help_text='–®–∏—Ä–∏–Ω–∞ 328px, –≤—ã—Å–æ—Ç–∞ 205px')
    address = models.CharField(max_length=255, verbose_name='–∞–¥—Ä–µ—Å', blank=True, null=True)
    contact_person = models.ForeignKey(User, on_delete=models.SET_NULL, related_name='contact_persons',
                                       verbose_name='–∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ', blank=True, null=True)

    def __str__(self):
        return self.name

    def get_available_promotions(user):
        if user.is_staff:
            # –ö—É—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–æ—â—Ä–µ–Ω–∏—è
            promotions = Promotion.objects.filter(is_active=True)
        else:
            #  –≤–æ–ª–æ–Ω—Ç—ë—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ–æ—â—Ä–µ–Ω–∏—è, –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤
            promotions = Promotion.objects.filter(is_active=True, for_curators_only=False)
        return promotions

    def clean(self):
        if not self.is_permanent and not self.end_date:
            raise ValidationError("–£–∫–∞–∂–∏—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ –ø–æ–æ—â—Ä–µ–Ω–∏–µ –∫–∞–∫ –±–µ—Å—Å—Ä–æ—á–Ω–æ–µ.")
        if self.is_permanent and self.end_date:
            raise ValidationError("–ë–µ—Å—Å—Ä–æ—á–Ω–æ–µ –ø–æ–æ—â—Ä–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è.")
        if self.available_quantity > self.quantity:
            raise ValidationError("–î–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.")

    def save(self, *args, **kwargs):
        if not self.pk:  # –ï—Å–ª–∏ –ø–æ–æ—â—Ä–µ–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤–ø–µ—Ä–≤—ã–µ, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º available_quantity —Å quantity
            self.available_quantity = self.quantity
        super().save(*args, **kwargs)

    def get_absolute_url(self):
        return reverse('admin:promo_app_promotion_change', args=[self.pk])

    # –ü–æ–¥—Å—á–µ—Ç —á–∏—Å–ª–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–æ—â—Ä–µ–Ω–∏–π
    def volunteers_count(self):
        return self.participation_set.count()

    @admin.display(description="—É—á–∞—Å—Ç–Ω–∏–∫–∏")
    def display_volunteers(self):
        verbose_name = "—É—á–∞—Å—Ç–Ω–∏–∫" if self.volunteers_count() == 1 else "—É—á–∞—Å—Ç–Ω–∏–∫–∏"
        return format_html("<br>".join([str(user) for user in self.users.all()]))

    class Meta:
        verbose_name = '–ø–æ–æ—â—Ä–µ–Ω–∏–µ'
        verbose_name_plural = '–ø–æ–æ—â—Ä–µ–Ω–∏—è'


class Participation(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, verbose_name='–≤–æ–ª–æ–Ω—Ç—ë—Ä')
    promotion = models.ForeignKey(Promotion, on_delete=models.CASCADE, verbose_name='–ø–æ–æ—â—Ä–µ–Ω–∏–µ')
    received_at = models.DateTimeField(auto_now_add=True, verbose_name='–¥–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è')
    is_active = models.BooleanField(default=False, verbose_name='–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ')

    def __str__(self):
        return str(self.user)

    def save(self, *args, **kwargs):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–æ—â—Ä–µ–Ω–∏—è
        if self.promotion.available_quantity <= 0:
            raise ValidationError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–æ—â—Ä–µ–Ω–∏–π.")

        # –£–º–µ–Ω—å—à–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–æ—â—Ä–µ–Ω–∏–π
        self.promotion.available_quantity -= 1
        self.promotion.save()

        super().save(*args, **kwargs)

    def save_without_reward_check(self, *args, **kwargs):
        super().save(*args, **kwargs)

    def delete(self, *args, **kwargs):
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–æ—â—Ä–µ–Ω–∏–µ –≤ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        self.promotion.available_quantity += 1
        self.promotion.save()

        super().delete(*args, **kwargs)

    class Meta:
        verbose_name = '—É—á–∞—Å—Ç–Ω–∏–∫–∏'
        verbose_name_plural = '—É—á–∞—Å—Ç–Ω–∏–∫–∏'


class PromoCategory(models.Model):
    name = models.CharField(max_length=255, verbose_name='–Ω–∞–∑–≤–∞–Ω–∏–µ')

    def __str__(self):
        return self.name

    class Meta:
        verbose_name = '–∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ–æ—â—Ä–µ–Ω–∏–π'
        verbose_name_plural = '–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–æ—â—Ä–µ–Ω–∏–π'


